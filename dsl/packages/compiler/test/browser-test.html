<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Browser Compiler Test</title>
  <style>
    body { font-family: system-ui; padding: 20px; background: #1e1e1e; color: #d4d4d4; }
    pre { background: #2d2d2d; padding: 12px; border-radius: 4px; overflow-x: auto; }
    .success { color: #4ec9b0; }
    .error { color: #f48771; }
    button { background: #0e639c; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin: 8px 0; }
    button:disabled { background: #3c3c3c; }
    #status { margin: 12px 0; }
  </style>
</head>
<body>
  <h1>Browser Compiler Test</h1>
  <p>This page tests the @ranking-dsl/compiler browser bundle.</p>

  <div id="status">Status: Loading...</div>
  <button id="compile-btn" disabled>Compile Test Plan</button>

  <h3>Test Plan Source:</h3>
  <pre id="source"></pre>

  <h3>Compilation Result:</h3>
  <pre id="result">Click "Compile Test Plan" to see result</pre>

  <!-- Import maps for ESM modules -->
  <script type="importmap">
  {
    "imports": {
      "esbuild-wasm": "https://esm.sh/esbuild-wasm@0.19.12",
      "quickjs-emscripten": "https://esm.sh/quickjs-emscripten@0.29.2"
    }
  }
  </script>

  <script type="module">
    const TEST_PLAN = `import { definePlan } from '@ranking-dsl/runtime';
import { Key, P } from '@ranking-dsl/generated';

export default definePlan({
  name: 'browser_test',
  build: (ctx) => {
    const source = ctx.viewer.follow({ fanout: 50 });
    const scored = source.vm({ outKey: Key.final_score, expr: Key.id * 0.1 });
    return scored.take({ count: 5 });
  },
});
`;

    document.getElementById('source').textContent = TEST_PLAN;

    const statusEl = document.getElementById('status');
    const resultEl = document.getElementById('result');
    const compileBtn = document.getElementById('compile-btn');

    // Dynamically import the browser compiler
    async function loadCompiler() {
      statusEl.textContent = 'Status: Loading compiler module...';

      // Import the local browser bundle
      const { initCompiler, compilePlan } = await import('../dist/browser.js');

      statusEl.textContent = 'Status: Initializing WASM (esbuild + quickjs)...';
      await initCompiler();

      statusEl.innerHTML = '<span class="success">Status: Ready!</span>';
      compileBtn.disabled = false;

      return { compilePlan };
    }

    async function runTest(compilePlan) {
      compileBtn.disabled = true;
      statusEl.textContent = 'Status: Compiling...';
      resultEl.textContent = 'Compiling...';

      const startTime = performance.now();
      const result = await compilePlan(TEST_PLAN, 'browser_test');
      const elapsed = (performance.now() - startTime).toFixed(0);

      if (result.success) {
        statusEl.innerHTML = `<span class="success">Status: Compiled successfully in ${elapsed}ms</span>`;
        resultEl.textContent = JSON.stringify(result.artifact, null, 2);
      } else {
        statusEl.innerHTML = `<span class="error">Status: Compilation failed (${result.phase})</span>`;
        resultEl.innerHTML = `<span class="error">${result.error}</span>`;
      }

      compileBtn.disabled = false;
    }

    // Main
    loadCompiler()
      .then(({ compilePlan }) => {
        compileBtn.onclick = () => runTest(compilePlan);
      })
      .catch(err => {
        statusEl.innerHTML = `<span class="error">Status: Failed to load compiler</span>`;
        resultEl.innerHTML = `<span class="error">${err.message}\n\n${err.stack}</span>`;
      });
  </script>
</body>
</html>
