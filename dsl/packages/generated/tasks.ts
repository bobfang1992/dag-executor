// AUTO-GENERATED from C++ TaskSpec - DO NOT EDIT
// Generated by dsl/src/codegen.ts from registry/tasks.toml
// Regenerate with: pnpm -C dsl run gen

import type { KeyToken } from "./keys.js";
import type { RedisEndpointId } from "./endpoints.js";

// =====================================================
// Expression types (narrow discriminated unions)
// =====================================================

/** ExprNode - matches engine's ExprIR format (builder-style) */
export type ExprNode =
  | { op: "const_number"; value: number }
  | { op: "const_null" }
  | { op: "key_ref"; key_id: number }
  | { op: "param_ref"; param_id: number }
  | { op: "add"; a: ExprNode; b: ExprNode }
  | { op: "sub"; a: ExprNode; b: ExprNode }
  | { op: "mul"; a: ExprNode; b: ExprNode }
  | { op: "neg"; x: ExprNode }
  | { op: "coalesce"; a: ExprNode; b: ExprNode };

/** ExprPlaceholder - compile-time placeholder for natural expression syntax */
export interface ExprPlaceholder {
  __expr_id: number;
}

/** ExprInput - expression input type for tasks (builder or natural syntax) */
export type ExprInput = ExprNode | ExprPlaceholder;

// =====================================================
// Predicate types (narrow discriminated unions)
// =====================================================

/** Regex pattern - literal string or param reference */
export type RegexPattern =
  | { kind: "literal"; value: string }
  | { kind: "param"; param_id: number };

/** PredNode - matches engine's PredIR format */
export type PredNode =
  | { op: "const_bool"; value: boolean }
  | { op: "and"; a: PredNode; b: PredNode }
  | { op: "or"; a: PredNode; b: PredNode }
  | { op: "not"; x: PredNode }
  | { op: "cmp"; cmp: "==" | "!=" | "<" | "<=" | ">" | ">="; a: ExprNode; b: ExprNode }
  | { op: "in"; lhs: ExprNode; list: (number | string)[] }
  | { op: "is_null"; x: ExprNode }
  | { op: "not_null"; x: ExprNode }
  | { op: "regex"; key_id: number; pattern: RegexPattern; flags: string };

/** PredPlaceholder - compile-time placeholder for natural predicate syntax */
export interface PredPlaceholder {
  __pred_id: number;
}

/** PredInput - predicate input type for tasks (builder or natural syntax) */
export type PredInput = PredNode | PredPlaceholder;

// =====================================================
// Node reference types (for tasks like concat)
// =====================================================

/** Interface for CandidateSet used by NodeRef params (avoids circular dep with runtime) */
export interface CandidateSetLike {
  getNodeId(): string;
}

// =====================================================
// Source task option interfaces
// =====================================================

export interface CoreViewerOpts {
  endpoint: RedisEndpointId;
  trace?: string | null;
  extensions?: Record<string, unknown>;
}

// =====================================================
// Transform task option interfaces
// =====================================================

export interface CoreConcatOpts {
  rhs: CandidateSetLike;
  trace?: string | null;
  extensions?: Record<string, unknown>;
}

export interface CoreFilterOpts {
  pred: PredInput;
  trace?: string | null;
  extensions?: Record<string, unknown>;
}

export interface CoreFollowOpts {
  endpoint: RedisEndpointId;
  fanout: number;
  trace?: string | null;
  extensions?: Record<string, unknown>;
}

export interface CoreMediaOpts {
  endpoint: RedisEndpointId;
  fanout: number;
  trace?: string | null;
  extensions?: Record<string, unknown>;
}

export interface CoreRecommendationOpts {
  endpoint: RedisEndpointId;
  fanout: number;
  trace?: string | null;
  extensions?: Record<string, unknown>;
}

export interface CoreSortOpts {
  by: KeyToken;
  order?: string;
  trace?: string | null;
  extensions?: Record<string, unknown>;
}

export interface CoreTakeOpts {
  count: number;
  trace?: string | null;
  extensions?: Record<string, unknown>;
}

export interface CoreVmOpts {
  expr: ExprInput;
  outKey: KeyToken;
  trace?: string | null;
  extensions?: Record<string, unknown>;
}

export interface TestBusyCpuOpts {
  busyWaitMs: number;
  trace?: string | null;
  extensions?: Record<string, unknown>;
}

export interface TestFixedSourceOpts {
  rowCount?: number;
  trace?: string | null;
  extensions?: Record<string, unknown>;
}

export interface TestSleepOpts {
  durationMs: number;
  failAfterSleep?: boolean;
  trace?: string | null;
  extensions?: Record<string, unknown>;
}

// =====================================================
// Metadata
// =====================================================

export const TASK_MANIFEST_DIGEST = "4a2e3e796f5c3cf45f1283b4a91580d0f6e3bb2d3b757f06cfd05da5dcaff8a6";
export const TASK_COUNT = 12;

// =====================================================
// Task extraction metadata (for AST extractor)
// =====================================================

/** Extraction info for a task - which properties to extract as expr/pred */
export interface TaskExtractionInfo {
  /** Property name containing expression (for tasks with expr_id param) */
  exprProp?: string;
  /** Property name containing predicate (for tasks with pred_id param) */
  predProp?: string;
}

/** Map from method name to extraction info */
export const TASK_EXTRACTION_INFO: Record<string, TaskExtractionInfo> = {
  "filter": { predProp: "pred" },
  "vm": { exprProp: "expr" },
};
